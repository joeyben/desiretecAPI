version: '3'

services:
    app:
      build:
        context: .
        dockerfile: Dockerfile
      depends_on:
        - mariadb
        - redis
        - laravel-echo-server
      volumes:
        - /var/www/desiretec-mvp-stage/storage:/var/www/html/storage
      environment:
        - VIRTUAL_HOST=mvp.desiretec.com,novasol.wunsch-service.de,trendtours.reise-wunsch.com,*.wish-service.com,*.reise-wunsch.de,*.reise-wunsch.com
#        - LETSENCRYPT_HOST=mvp.desiretec.com,novasol.wunsch-service.de,trendtours.reise-wunsch.com
#        - VIRTUAL_HOST=mvp.desiretec.com,novasol.wunsch-service.de,*.wish-service.com,*.reise-wunsch.de,*.reise-wunsch.com,trendtours.reise-wunsch.com
#        - LETSENCRYPT_HOST=mvp.desiretec.com,novasol.wunsch-service.de,*.reise-wunsch.com,trendtours.reise-wunsch.com
#        - LETSENCRYPT_EMAIL=info@desiretec.com
      networks:
        - frontend
        - backend
    mariadb:
      image: mariadb:latest
      environment:
        - MYSQL_USER=default
        - MYSQL_PASSWORD=${DB_STAGE_PW}
        - MYSQL_DATABASE=default
        - MYSQL_ROOT_PASSWORD=${DB_ROOT_PW}
      ports:
        - "127.0.0.1:3300:3306"
      networks:
        - backend
    redis:
      image: redis:latest
      networks:
        - backend
    laravel-echo-server:
      build:
        context: ./laravel-echo-server
      volumes:
        - ./laravel-echo-server/laravel-echo-server.json:/app/laravel-echo-server.json:ro
        - /etc/letsencrypt:/app/mvp_certs/live:ro
#        - nginx-reverse-proxy_le-certs:/app/mvp_certs/:ro
#        - reverseproxy_certs:/app/mvp_certs/:ro
      ports:
        - 6001:6001
      links:
        - redis
      networks:
        - frontend
        - backend
      command: tail -f /dev/null

networks:
    frontend:
      external:
        name: nginx-proxy-wildcard
#        name: nginx-reverse-proxy_http_proxy
#        name: reverseproxy_http_proxy
    backend:

volumes:
    nginx-reverse-proxy_le-certs:
      external: true
